<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa con búsqueda de coordenadas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 500px; margin-bottom: 10px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    th, td { text-align: left; }
  </style>
</head>
<body>
  <h2>Mapa de propiedades</h2>
  <input type="text" id="coordInput" placeholder="-12.1336, -77.0126" style="width: 300px;">
  <button onclick="buscarCoordenada()">Buscar</button>
  
  <div id="map"></div>

  <h3>Tabla de propiedades</h3>
  <div id="tabla-container"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-12.133, -77.02], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    let markers = [];
    let datos = [];

    function cargarCSV() {
      fetch('datos.csv')
        .then(response => response.text())
        .then(data => {
          const lineas = data.trim().split('\n');
          const headers = lineas[0].split('\t');
          for (let i = 1; i < lineas.length; i++) {
            const fila = lineas[i].split('\t');
            if (fila.length < 3) continue;

            const id = fila[0];
            const link = fila[1];
            const coords = fila[2].split(',').map(c => parseFloat(c.trim()));
            if (coords.length !== 2) continue;

            const obj = { id, link, lat: coords[0], lng: coords[1] };
            datos.push(obj);

            const marker = L.marker([obj.lat, obj.lng])
              .addTo(map)
              .bindPopup(`<a href="${obj.link}" target="_blank">${obj.id}</a>`);
            markers.push(marker);
          }
          crearTabla(datos);
        });
    }

    function buscarCoordenada() {
      const input = document.getElementById('coordInput').value;
      const coords = input.split(',').map(c => parseFloat(c.trim()));
      if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
        alert("Formato inválido. Usa: latitud, longitud");
        return;
      }
      map.setView(coords, 18);
      L.circleMarker(coords, { radius: 10, color: 'red' }).addTo(map).bindPopup("Coordenada buscada").openPopup();
    }

    function crearTabla(datos) {
      let html = '<table><tr><th>ID</th><th>Link</th><th>Coordenadas</th></tr>';
      datos.forEach(d => {
        html += `<tr><td>${d.id}</td><td><a href="${d.link}" target="_blank">Ver</a></td><td>${d.lat}, ${d.lng}</td></tr>`;
      });
      html += '</table>';
      document.getElementById('tabla-container').innerHTML = html;
    }

    cargarCSV();
  </script>
</body>
</html>
